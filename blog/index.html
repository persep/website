<!DOCTYPE html> <html> <head> <title>Alpine Lab, blog technique</title> <meta charset=UTF-8> <meta content="On parle de développement web, d'entreprenariat, de Ruby, de Rails, de Haml, de CSS/Sass, de CoffeeScript et d'Ember.js, ..." name=description> <meta content='width=device-width, initial-scale=1.0, user-scalable=no' name=viewport> <meta content='Alpine Lab, blog technique' property='og:title'> <meta content="On parle de développement web, d'entreprenariat, de Ruby, de Rails, de Haml, de CSS/Sass, de CoffeeScript et d'Ember.js, ..." property='og:description'> <meta content=fr_FR property='og:locale'> <meta content='Alpine Lab' property='og:site_name'> <meta content='http://www.alpine-lab.com/blog/' property='og:url'> <meta content='http://www.alpine-lab.com../images/logo-alpinelab-500.png' property='og:image'> <meta content=website property='og:type'> <link href='images/favicon.png' rel=icon> <link href='//fonts.googleapis.com/css?family=Lato:300,400,700%7CMontserrat:400,700' rel=stylesheet> <link href="../stylesheets/blog-fb2780ef.css" rel=stylesheet /> <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.min.css" rel=stylesheet /> </head> <body class='blog blog_index'> <meta content='Alpine Lab, blog technique' itemprop=name> <meta content="On parle de développement web, d'entreprenariat, de Ruby/Rails, de Haml/Slim, de Sass, de CoffeeScript et d'Ember.js" itemprop=description> <meta content='http://www.alpine-lab.com/blog' itemprop=url> <meta content=fr itemprop=inLanguage> <meta content='http://www.alpine-lab.com../images/logo-alpinelab-500.png' itemprop=image> <div id=wrapper> <header> <a href="/blog"><div class=logo></div> <h1 class=sitename><span class=alpine>Alpine</span><span class=lab>Lab</span> <span class=blog>blog technique</span> </h1> </a> <div class=social-networks> <a target=_blank href="https://github.com/alpinelab"><i class='fa fa-github'></i> </a> <a target=_blank href="https://twitter.com/alpinelab"><i class='fa fa-twitter'></i> </a> </div> </header> <div id=main> <section class=posts-listing> <article itemscope itemtype='http://schema.org/BlogPosting'> <meta content='&lt;p&gt;Chez &lt;a href="//www.alpine-lab.com"&gt;AlpineLab&lt;/a&gt;, on essaye parfois de s&#x0027;ouvrir l&#x0027;esprit et de ne pas faire que du Ruby. Depuis quelques temps, on s&#x0027;essaye à &lt;a href="https://www.elixir-lang.org"&gt;Elixir&lt;/a&gt; et son framework web &lt;a href="https://www.phoenixframework.org"&gt;Phoenix&lt;/a&gt;. Un des (nombreux) points forts de Phoenix est d&#x0027;offrir une communication bidirectionnelle...&lt;/p&gt;' itemprop=description> <meta content='http://www.alpine-lab.com/blog/utiliser-les-presences-de-phoenix/' itemprop=url> <meta content=fr itemprop=inLanguage> <h2 itemprop='name headline'><a href="/blog/utiliser-les-presences-de-phoenix/">Utiliser les Presences de Phoenix</a></h2> <div class=post-body itemprop=articleBody> <p>Chez <a href="//www.alpine-lab.com">AlpineLab</a>, on essaye parfois de s&#39;ouvrir l&#39;esprit et de ne pas faire que du Ruby. Depuis quelques temps, on s&#39;essaye à <a href="https://www.elixir-lang.org">Elixir</a> et son framework web <a href="https://www.phoenixframework.org">Phoenix</a>. Un des (nombreux) points forts de Phoenix est d&#39;offrir une communication bidirectionnelle entre le serveur et les clients avec une simplicité enfantine grâce à son implémentation des <a href="//www.phoenixframework.org/docs/channels">Channels</a>.</p> <p>Dans sa version 1.2 (actuellement en release candidate) son créateur <a href="https://github.com/chrismccord">Chris McChord</a> a introduit la notion de <a href="https://hexdocs.pm/phoenix/1.2.0-rc.1/Phoenix.Presence.html">Presence</a>. Comme son nom l&#39;indique assez bien, ça permet de tracker les clients (navigateurs) qui sont connectés au &ldquo;serveur&rdquo; (entre guillemets, parce que le &ldquo;serveur&rdquo; sous Phoenix est prévu pour être distribué et décentralisé) de manière fiable (consistente, répliquée, temps-réel et sans conflit ni collision). Il explique super bien le fonctionnement des <code>Presence</code>s dans son intervention à <a href="//www.elixirconf.eu">ElixirConf Europe</a> ci-dessous:</p> <div style="text-align: center"><iframe width=560 height=315 align=middle src="https://www.youtube.com/embed/n338leKvqnA" frameborder=0 allowfullscreen></iframe></div> <p>Si vous vous en foutez de savoir comment ça marche (on ne juge pas), laissez tomber la vidéo : on va voir comment utiliser les <code>Presence</code>s en quelques lignes de code seulement, tellement c&#39;est facile.</p> <p>On admet que vous avez déjà une application Phoenix qui tourne et qui s&#39;appelle intelligemment <code>MyApp</code> (mais libre à vous d&#39;adapter à votre cas) et une implémentation basique (serveur et client) des <code>Channel</code>s. On va lui ajouter le support des <code>Presence</code>s.</p> <h2 id="1.-installation">1. Installation</h2> <p>Il faut tout d&#39;abord installer Phoenix 1.2+ (au moment où j&#39;écris ces lignes, la version la plus récente est <code>1.2.0-rc.1</code>). Mettez donc à jour vos dépendances dans <code>mix.exs</code> pour utiliser une version 1.2+:</p> <pre class="highlight elixir"><code>  <span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>&#x000A;    <span class="p">[</span>&#x000A;      <span class="p">{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.2.0-rc.1"</span><span class="p">},</span>&#x000A;      <span class="o">...</span> <span class="c1"># probablement d'autres dépendences ici</span>&#x000A;    <span class="p">]</span>&#x000A;  <span class="k">end</span>&#x000A;</code></pre> <p>Puis lancez installer la nouvelle version (et ses nouvelles dépendances) depuis un shell:</p> <pre class="highlight shell"><code><span class="gp">$ </span>mix deps.get&#x000A;</code></pre> <p>D&#39;autre part, <code>npm</code> va télécharger ses dépendances <code>phoenix</code> et <code>phoenix_html</code> non pas sur le serveur <code>npm</code> comme d&#39;habitude, mais directement sur votre disque dur et les copie dans <code>node_modules</code>. C&#39;est pour ça que votre <code>package.json</code> doit probablement déjà contenir ces dépendances:</p> <pre class="highlight plaintext"><code>  "phoenix":      "file:deps/phoenix",&#x000A;  "phoenix_html": "file:deps/phoenix_html",&#x000A;</code></pre> <p>Bref, ce qu&#39;il faut donc faire, c&#39;est dire à <code>npm</code> qu&#39;il faut re-&ldquo;télécharger&rdquo; ces fichiers, puisqu&#39;ils ont changé et sont maintenant en version 1.2. un simple:</p> <pre class="highlight shell"><code><span class="gp">$ </span>npm update phoenix phoenix_html&#x000A;</code></pre> <h2 id="2.-configuration">2. Configuration</h2> <p>Pour utiliser les <code>Presence</code>s, il faut tout d&#39;abord démarrer leur superviseur depuis <code>lib/my_app.ex</code>. Ajoutez les lignes suivantes au tableau <code>children</code> (vous verrez, il doit y en avoir déjà au moins un autre):</p> <pre class="highlight elixir"><code><span class="n">children</span> <span class="o">=</span> <span class="p">[</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">supervisor</span><span class="p">(</span><span class="no">MyApplication</span><span class="o">.</span><span class="no">UserPresence</span><span class="p">,</span> <span class="p">[])</span>&#x000A;<span class="p">]</span>&#x000A;</code></pre> <p>Ensuite, il faut créer un module de <code>Presence</code> dans notre application qu&#39;on nommera simplement <code>MyPresence</code>. On créé donc un fichier <code>web/channels/my_presence.ex</code> dans lequel on va écrire:</p> <pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyPresence</span> <span class="k">do</span>&#x000A;  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Presence</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:my_app</span><span class="p">,</span>&#x000A;                        <span class="ss">pubsub_server:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">PubSub</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Voilà, c&#39;est tout. On va enfin pouvoir passer aux choses intéressantes.</p> <h2 id="3.-implémentation">3. Implémentation</h2> <p>Le fonctionnement est simple, il se décompose en 3 actions distinctes:</p> <ol> <li>lorsqu&#39;un client se connecte à un channel, il fournit un identifiant et le serveur l&#39;enregistre dans sa liste de <code>Presence</code>s (avec éventuellement des meta-données de votre choix)</li> <li>le serveur lui envoie alors l&#39;état actuel des <code>Presence</code>s (<em>i.e.</em> des autres clients connectés au même channel) sous forme d&#39;un message <code>presence_state</code></li> <li>périodiquement, le serveur va envoyer une mise à jour de l&#39;état des présences (<em>i.e.</em> une liste de clients s&#39;étant connectés et une liste des clients s&#39;étant déconnectés) sous la forme d&#39;un message <code>presence_diff</code></li> </ol> <p>C&#39;est tout. La synchronisation entre les différents serveur distribués est faite automatiquement, on n&#39;a pas à s&#39;en occuper.</p> <h3 id="côté-serveur-(channel)">Côté serveur (Channel)</h3> <p>Tout se passe dans le fichier qui déclare votre module <code>Channel</code> (genre <code>web/channels/my_channel.ex</code>). Pour plus de confort, commencez par aliaser votre module <code>MyPresence</code>:</p> <pre class="highlight elixir"><code><span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyPresence</span>&#x000A;</code></pre> <p>Ça permet tout simplement d&#39;utiliser <code>MyPresence</code> plutôt que <code>MyApp.MyPresence</code> dans le reste du module.</p> <p>Quand un client se connecte, c&#39;est la fonction <a href="https://hexdocs.pm/phoenix/1.2.0-rc.1/Phoenix.Channel.html#c:join/3"><code>join/3</code></a> qui est appelée avec comme arguments le topic (<em>i.e.</em> le nom) du <code>Channel</code> auquel il se connecte, un <code>Map</code> de paramètres ainsi que le <code>Socket</code> qui gère la connexion.</p> <p>Dans notre exemple, on va attendre du client qu&#39;il envoie dans les paramètres un <code>user_name</code> pour s&#39;authentifier. On va donc modifier la jonction <code>join/3</code> pour stocker dans le <code>Socket</code> le <code>user_name</code> fourni (on pourra alors le récupérer de n&#39;importe où, le <code>Socket</code> étant passé à toutes les fonctions liées au <code>Channel</code>). On fait ça grâce à la méthode <a href="https://hexdocs.pm/phoenix/1.2.0-rc.1/Phoenix.Socket.html#assign/3"><code>assign/3</code></a> qui stocke des données clef-valeur dans un <code>Socket</code>. On modifie donc la fonction <code>join/3</code> pour ne pas retourner simplement <code>{:ok, socket}</code> mais ceci:</p> <pre class="highlight elixir"><code><span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">channel:"</span> <span class="o">&lt;&gt;</span> <span class="n">_channel_id</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="sd">"</span><span class="s2">user_name"</span><span class="p">])}</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>On va ensuite ajouter un callback <code>after_join</code> qui va ajouter le client qui vient de se connecter (authentifié par le <code>user_name</code> stocké dans son <code>Socket</code>) à la liste de <code>Presence</code> du serveur. On utilise pour ça la fonction <a href="https://hexdocs.pm/phoenix/1.2.0-rc.1/Phoenix.Presence.html#c:track/3"><code>track/3</code></a> de notre module <code>MyPresence</code> (qui le tient lui-même du module <code>Phoenix.Presence</code>) en lui passant le <code>user_name</code> précédemment assigné au <code>Socket</code>, pour obtenir ce qui suit:</p> <pre class="highlight elixir"><code><span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">channel:"</span> <span class="o">&lt;&gt;</span> <span class="n">_channel_id</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="ss">:after_join</span><span class="p">)</span>&#x000A;  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="sd">"</span><span class="s2">user_name"</span><span class="p">])}</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="no">MyPresence</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="p">%{})</span>&#x000A;  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Notez qu&#39;on doit appeler explicitement <code>after_join</code> dans <code>join/3</code> et que le 3ème argument de <code>track/3</code> permet de stocker n&#39;importe quelles données qui seront passées aux clients.</p> <p>Ça constitue l&#39;étape 1 de notre implémentation décrite ci-dessus (l&#39;enregistrement du client dans les <code>Presence</code>s du serveur).</p> <p>Pour implémenter l&#39;étape 2 (l&#39;envoi au client de la liste actuelle des <code>Presence</code>s du serveur), il suffit d&#39;envoyer au client un message <code>presence_state</code> contenant le résultat de la fonction <a href="https://hexdocs.pm/phoenix/1.2.0-rc.1/Phoenix.Presence.html#list/2"><code>list/1</code></a> de <code>MyPresence</code> (qu&#39;il tient une fois de plus de <code>Phoenix.Presence</code>):</p> <pre class="highlight elixir"><code><span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">channel:"</span> <span class="o">&lt;&gt;</span> <span class="n">_channel_id</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="ss">:after_join</span><span class="p">)</span>&#x000A;  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="sd">"</span><span class="s2">user_name"</span><span class="p">])}</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="no">MyPresence</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="p">%{})</span>&#x000A;  <span class="n">push</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">presence_state"</span><span class="p">,</span> <span class="no">MyPresence</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>&#x000A;  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Easy !</p> <h3 id="côté-client-(js)">Côté client (JS)</h3> <p>Côté client, on va déjà modifier le code qui se connecte au <code>Channel</code> pour lui passer un <code>user_name</code>. Ça doit donc ressembler à ça:</p> <pre class="highlight javascript"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">channel</span><span class="p">(</span><span class="s2">"channel:general"</span><span class="p">,</span> <span class="p">{</span><span class="na">user_name</span><span class="p">:</span> <span class="s2">"Mike"</span><span class="p">})</span>&#x000A;</code></pre> <p>Vous aurez pris soin dans la vraie vie de remplacer les valeurs du topic du <code>Channel</code> et du <code>user_name</code> par ce qui vous chante, souvent un truc entré par l&#39;utilisateur&hellip; au moins pour le <code>user_name</code> ;-)</p> <p>Maintenant on va faire en sorte de gérer correctement les messages <code>presence_state</code> et <code>presence_diff</code> que nous envoie le serveur.</p> <p>Pour gérer les message entrants, on avait déjà la fonction <code>.on()</code> fournie par la classe <code>Channel</code> du package <code>phoenix</code>. On va aussi utiliser les fonctions <code>.syncState()</code> et <code>.syncDiff()</code> de la nouvelle classe <code>Presence</code> du même package pour mettre à jour une liste des clients connectés avec le contenu du message envoyé par le serveur (respectivement <code>presence_state</code> et <code>presence_diff</code>, donc).</p> <p>Si ce n&#39;est pas très clair, c&#39;est parce que je m&#39;exprime mal, mais vous allez voir que c&#39;est super simple avec du code (ES6):</p> <pre class="highlight javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">Socket</span><span class="p">,</span> <span class="nx">Presence</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">"phoenix"</span>&#x000A;&#x000A;<span class="p">...</span> <span class="c1">// initialisation du socket et du channel</span>&#x000A;&#x000A;<span class="kd">let</span> <span class="nx">connectedUsers</span> <span class="o">=</span> <span class="p">[]</span>&#x000A;&#x000A;<span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"presence_state"</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>&#x000A;  <span class="nx">Presence</span><span class="p">.</span><span class="nx">syncState</span><span class="p">(</span><span class="nx">connectedUsers</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span>&#x000A;<span class="p">})</span>&#x000A;&#x000A;<span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"presence_diff"</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>&#x000A;  <span class="nx">Presence</span><span class="p">.</span><span class="nx">syncDiff</span><span class="p">(</span><span class="nx">connectedUsers</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span>&#x000A;<span class="p">})</span>&#x000A;</code></pre> <p>Et paf ! Votre tableau <code>connectedUsers</code> sera automatiquement mis à jour lorsque le serveur vous notifiera qu&#39;il y a eu des changements dans sa liste de <code>Presence</code> (et il contient également toutes les meta-données que vous auriez passées à <code>MyPresence.track/3</code> dans le <code>Channel</code> côté serveur).</p> </div> </article> <article itemscope itemtype='http://schema.org/BlogPosting'> <meta content='&lt;p&gt;En travaillant sur la gem de &lt;a href="//www.localeapp.com"&gt;Locale&lt;/a&gt;, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l&amp;#39;exécution du code.' itemprop=description> <meta content='http://www.alpine-lab.com/blog/des-helpers-pour-verifier-la-version-de-rails/' itemprop=url> <meta content=fr itemprop=inLanguage> <h2 itemprop='name headline'><a href="/blog/des-helpers-pour-verifier-la-version-de-rails/">Des helpers pour vérifier la version de Rails</a></h2> <div class=post-body itemprop=articleBody> <p>En travaillant sur la gem de <a href="//www.localeapp.com">Locale</a>, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l&#39;exécution du code.</p> <p><strong>TL;DR :</strong> les helpers sont disponibles <a href="https://gist.github.com/michaelbaudino/8884362">dans ce Gist</a></p> <p>En l&#39;occurrence, il fallait s&#39;adapter à un comportement de Rails que l&#39;on observe dans Rails 3.2.16+ et Rails 4.0.2+ (suite à un patch pour une n-ième faille de sécu dans la gestion des fichiers YAML).</p> <p>Déjà, il faut savoir que les numéros de version de Rails sont stockés dans le module <code>::Rails::VERSION</code> qui contient 4 constantes :</p> <ul> <li><code>MAJOR</code>: le numéro de version majeur (pour 4.0.2, c&#39;est 4)</li> <li><code>MINOR</code>: le numéro de version mineur (pour 4.0.2, c&#39;est 0)</li> <li><code>TINY</code>: le numéro de patch (pour 4.0.2, c&#39;est 2)</li> <li><code>STRING</code>: le numéro de version complet sous forme de string (donc pour 4.0.2, c&#39;est &ldquo;4.0.2&rdquo;)</li> </ul> <p>La façon bourrine de vérifier qu&#39;on est dans un de ces deux cas est la suivante :</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MAJOR</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">TINY</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)))</span>&#x000A;<span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MAJOR</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">TINY</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)))</span>&#x000A;  <span class="c1"># votre code va ici</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>C&#39;est moche, hein ? Non, je n&#39;en suis pas fier.</p> <p>C&#39;est con parce qu&#39;il suffit de savoir qu&#39;il y a deux classes Ruby vachement utiles pour comparer les numéros de versions qui sont <a href="//www.ruby-doc.org/stdlib-2.1.0/libdoc/rubygems/rdoc/Gem/Requirement.html">Gem::Requirement</a> et <a href="//www.ruby-doc.org/stdlib-2.1.0/libdoc/rubygems/rdoc/Gem/Version.html">Gem::Version</a>.</p> <p><code>Gem::Requirement</code> permet de créer des <em>matchers</em>, genre &rsquo;~&gt; 4.0.2&rsquo; (ça vous dit quelque chose ?). <code>Gem::Version</code>, comme son nom l&#39;indique intelligemment, ça stocke un numéro de version. Et le lien utile entre les deux, c&#39;est la méthode <code>satisfied_by?</code> de <code>Gem::Requirement</code> qui renvoie vrai ou faux selon si l&#39;objet <code>Gem::Version</code> qu&#39;on lui passe en paramètre est conforme au <em>matcher</em>.</p> <p>Quelques exemples :</p> <pre class="highlight ruby"><code><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'&gt;= 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'3.2'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; false</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'&gt;= 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.1'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; true</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'~&gt; 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.0.3'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; true</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'~&gt; 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.1'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; false</span>&#x000A;</code></pre> <p>Voilà, à partir de là, tout est très simple, on créé une fonction qui fait la même chose - non pas par rapport à un numéro de version arbitraire - mais par rapport au numéro de version de Rails (dans lequel le code est exécuté) :</p> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">rails_version_matches?</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>&#x000A;  <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">requirement</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">::</span><span class="kp">new</span><span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Il nous suffit dans le code de faire:</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="n">rails_version_matches?</span> <span class="s1">'~&gt; 4.0.2'</span>&#x000A;  <span class="c1"># du code custom ici</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Classe, non ?</p> <p>Oui, mais nous on veut vérifier plusieurs versions de Rails (souvenez-vous : &ldquo;3.2.16+ <strong>et</strong> 4.0.2+&rdquo;).</p> <p>Pour ça, on va utiliser, des fonctions similaires mais qui prennent plusieurs <em>matchers</em> en paramètre, et qui vérifie que la version courante de Rails satisfait au moins un de ces <em>matchers</em> (pour la version <code>_any</code>) ou tous ces <em>matchers</em> à la fois (pour la version <code>_all</code>) en utilisant les opérateurs booléens <code>&amp;</code> et <code>|</code> entre leurs résultats :</p> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">rails_version_matches_any?</span><span class="p">(</span><span class="o">*</span><span class="n">requirements</span><span class="p">)</span>&#x000A;  <span class="n">requirements</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">rails_version_matches?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}.</span><span class="nf">reduce</span><span class="p">(</span><span class="ss">:|</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="k">def</span> <span class="nf">rails_version_matches_all?</span><span class="p">(</span><span class="o">*</span><span class="n">requirements</span><span class="p">)</span>&#x000A;  <span class="n">requirements</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">rails_version_matches?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}.</span><span class="nf">reduce</span><span class="p">(</span><span class="ss">:&amp;</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Au final, je teste que ma version courante de Rails est 3.2.16+ ou 4.0.2+ comme ça :</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="n">rails_version_matches_any?</span> <span class="s1">'~&gt; 3.2.16'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.2'</span>&#x000A;  <span class="c1"># mon code qui va bien</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Bien plus propre qu&#39;avant. Là, ça me plait.</p> </div> </article> <article itemscope itemtype='http://schema.org/BlogPosting'> <meta content='&lt;p&gt;Juste un petit mot pour vous dire qu&#x0027;on a été selectionnés pour présenter &lt;a href="https://www.skiwallet.com"&gt;SkiWallet&lt;/a&gt; au concours de startups de la conférence &lt;a href="//www.blendconference.com"&gt;Blend&lt;/a&gt;.&lt;/p&gt;&#x000A;&#x000A;&lt;p&gt;Voilà, on est super contents, d&#x0027;une parce qu&#x0027;on a été pris parmis une centaine de projets, de deux parce qu&#x0027;il y a...&lt;/p&gt;' itemprop=description> <meta content='http://www.alpine-lab.com/blog/skiwallet-a-la-conference-blend/' itemprop=url> <meta content=fr itemprop=inLanguage> <h2 itemprop='name headline'><a href="/blog/skiwallet-a-la-conference-blend/">SkiWallet à la conférence Blend</a></h2> <div class=post-body itemprop=articleBody> <p>Juste un petit mot pour vous dire qu&#39;on a été selectionnés pour présenter <a href="https://www.skiwallet.com">SkiWallet</a> au concours de startups de la conférence <a href="//www.blendconference.com">Blend</a>.</p> <p>Voilà, on est super contents, d&#39;une parce qu&#39;on a été pris parmis une centaine de projets, de deux parce qu&#39;il y a un <a href="//www.blendconference.com/speakers">lineup interminable</a> et de trois parce qu&#39;on espère rencontrer un paquet de gens motivés.</p> <p><img alt="Blend Web Mix" width=960 height=100 src="../../images/blog/blend-conf-0421ad9c.png"/></p> <p>En plus, on est aux côtés des copains de <a href="//www.simplauto.com">Simplauto</a> et de <a href="//www.tilkee.com">Tilkee</a> qui vont essayer de nous mettre la patée, mais on ne va pas se laisser faire :-)</p> <h3 id="minute-égocentrique">Minute égocentrique</h3> <p>À moitié parce que j&#39;ai envie de croire que ça intéresse qui que ce soit, et à moitié parce que ça me sert de mémo à moi-même, voilà ma sélection de gens que j&#39;ai bien envie de voir :</p> <ul> <li><a href="//www.blendconference.com/speakers/lea-verou">Lea Verou</a> (<a href="//www.twitter.com/leaverou">@leaverou</a>) pour ses <em>tricks</em> en CSS et sa vision du hacking : pour le fun et l&#39;esthétisme</li> <li><a href="//www.blendconference.com/speakers/mehdi-kabab/">Mehdi Kabab</a> (<a href="//www.twitter.com/piouPiouM">@piouPiouM</a>) parce que je kiffe Sass, Compass et <a href="//pioupioum.fr">son blog</a></li> <li><a href="//www.blendconference.com/speakers/christophe-porteneuve-2">Christophe Porteneuve</a> (<a href="//www.twitter.com/porteneuve">@porteneuve</a>) parce que pour avoir discuté avec lui à <a href="//2013.la-conf.org">La Conf</a>, c&#39;est vraiment un mec sympa</li> <li><a href="//www.blendconference.com/speakers/celine-lazorthes">Céline Lazorthes</a> (<a href="//www.twitter.com/CelineLz">@CelineLz</a>) parce que je l&#39;ai vue dans <a href="//www.lachainetechno.tv/videos/lappart-16-celine-lazorthes-avec-leetchi-nous-reinventons-la-cagnotte-entre-amis">un épisode de l&#39;Appart&rsquo;</a> et que j&#39;ai trouvé qu&#39;elle y amenait une vraie fraîcheur</li> <li><a href="//www.blendconference.com/speakers/guilhem-bertholet">Guilhem Bertholet</a> (<a href="//www.twitter.com/guilhem">@guilhem</a>), pas seulement parce qu&#39;il nous a selectionné pour ce <em>startup contest</em>, mais aussi parce que je kiffe <a href="//welovesaas.com">WeLoveSaaS</a></li> <li><a href="//www.blendconference.com/speakers/jean-daniel-guyot">Jean-Daniel Guyot</a> (<a href="//www.twitter.com/jdguyot">@jdguyot</a>) parce que <a href="https://www.skiwallet.com">SkiWallet</a> ne se veut après tout qu&#39;un <a href="https://app.capitainetrain.com">Capitaine Train</a> du ski</li> <li><a href="//www.blendconference.com/speakers/geoffrey-dorne">Geoffrey Dorne</a> (<a href="//www.twitter.com/geoffreydorne">@geoffreydorne</a>) pour ses billets &ldquo;<a href="//owni.fr/tag/vendredi-graphism">Vendredi c&#39;est Graphism</a>&rdquo; dans cette perle qu&#39;était <a href="//owni.fr">OWNI</a></li> <li><a href="//www.blendconference.com/speakers/maxime-valette">Maxime Valette</a> (<a href="//www.twitter.com/maxime">@maxime</a>) pour le remercier d&#39;avoir fait <a href="//www.betaseries.com">BetaSeries</a></li> </ul> </div> </article> <div class=pagination-wrapper> <a class=next-page href="/blog/page/2/">Articles plus anciens &rarr;</a> <div class=pagination> Page 1 sur 6 </div> </div> </section> </div> </div> <div id=corporate-btn> <a href="/">Alpine Lab <span class=caret></span> </a> </div> <footer> <p> Le blog d'<a rel=publisher href="https://plus.google.com/+AlpineLab">Alpine Lab</a> est publié sous license <a href="//creativecommons.org/licenses/by/3.0/fr/">Creative Commons Attribution 3.0 (cc-by-3.0)</a>. Le code est sous licence <a href="//opensource.org/licenses/MIT">MIT</a>. </p> </footer> </body> </html>