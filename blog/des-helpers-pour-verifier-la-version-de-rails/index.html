<!DOCTYPE html> <html> <head> <title>Des helpers pour vérifier la version de Rails</title> <meta charset=UTF-8> <meta content="En travaillant sur la gem de Locale, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l'exécution du code." name=description> <meta content='width=device-width, initial-scale=1.0, user-scalable=no' name=viewport> <meta content='Des helpers pour vérifier la version de Rails' property='og:title'> <meta content="En travaillant sur la gem de Locale, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l'exécution du code." property='og:description'> <meta content=fr_FR property='og:locale'> <meta content='Alpine Lab' property='og:site_name'> <meta content='http://www.alpine-lab.com/blog/des-helpers-pour-verifier-la-version-de-rails/' property='og:url'> <meta content='http://www.alpine-lab.com../../images/logo-alpinelab-500.png' property='og:image'> <meta content=article property='og:type'> <link href='images/favicon.png' rel=icon> <link href='//fonts.googleapis.com/css?family=Lato:300,400,700%7CMontserrat:400,700' rel=stylesheet> <link href="../../stylesheets/blog-fb2780ef.css" rel=stylesheet /> <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.min.css" rel=stylesheet /> </head> <body class='blog blog_des-helpers-pour-verifier-la-version-de-rails blog_des-helpers-pour-verifier-la-version-de-rails_index'> <meta content='Alpine Lab, blog technique' itemprop=name> <meta content="On parle de développement web, d'entreprenariat, de Ruby/Rails, de Haml/Slim, de Sass, de CoffeeScript et d'Ember.js" itemprop=description> <meta content='http://www.alpine-lab.com/blog' itemprop=url> <meta content=fr itemprop=inLanguage> <meta content='http://www.alpine-lab.com../../images/logo-alpinelab-500.png' itemprop=image> <div id=wrapper> <header> <a href="/blog"><div class=logo></div> <h1 class=sitename><span class=alpine>Alpine</span><span class=lab>Lab</span> <span class=blog>blog technique</span> </h1> </a> <div class=social-networks> <a target=_blank href="https://github.com/alpinelab"><i class='fa fa-github'></i> </a> <a target=_blank href="https://twitter.com/alpinelab"><i class='fa fa-twitter'></i> </a> </div> </header> <div id=main> <article itemscope itemtype='http://schema.org/BlogPosting'> <meta content="En travaillant sur la gem de Locale, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l'exécution du code." itemprop=description> <meta content='http://www.alpine-lab.com/blog/des-helpers-pour-verifier-la-version-de-rails/' itemprop=url> <meta content=fr itemprop=inLanguage> <h1 itemprop='name headline'>Des helpers pour vérifier la version de Rails</h1> <time class=published datetime=2014-02-08 itemprop=datePublished> Publié le 08/02/2014 </time> <ul class=tags> <li> <i class='fa fa-tags'></i> </li> <li><a href="/blog/tags/rails/">Rails</a></li> <li><a href="/blog/tags/helper/">Helper</a></li> <li><a href="/blog/tags/gem-development/">Gem development</a></li> </ul> <div class=post-body itemprop=articleBody> <p>En travaillant sur la gem de <a href="//www.localeapp.com">Locale</a>, et comme ça arrive souvent quand on développe une gem, on a eu besoin de charger du code spécifique pour certaines versions de Rails. Les petites fonctions toutes bêtes qui suivent servent à savoir dans quelle version de Rails on se trouve au moment de l&#39;exécution du code.</p> <p><strong>TL;DR :</strong> les helpers sont disponibles <a href="https://gist.github.com/michaelbaudino/8884362">dans ce Gist</a></p> <p>En l&#39;occurrence, il fallait s&#39;adapter à un comportement de Rails que l&#39;on observe dans Rails 3.2.16+ et Rails 4.0.2+ (suite à un patch pour une n-ième faille de sécu dans la gestion des fichiers YAML).</p> <p>Déjà, il faut savoir que les numéros de version de Rails sont stockés dans le module <code>::Rails::VERSION</code> qui contient 4 constantes :</p> <ul> <li><code>MAJOR</code>: le numéro de version majeur (pour 4.0.2, c&#39;est 4)</li> <li><code>MINOR</code>: le numéro de version mineur (pour 4.0.2, c&#39;est 0)</li> <li><code>TINY</code>: le numéro de patch (pour 4.0.2, c&#39;est 2)</li> <li><code>STRING</code>: le numéro de version complet sous forme de string (donc pour 4.0.2, c&#39;est &ldquo;4.0.2&rdquo;)</li> </ul> <p>La façon bourrine de vérifier qu&#39;on est dans un de ces deux cas est la suivante :</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MAJOR</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">TINY</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)))</span>&#x000A;<span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MAJOR</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">MINOR</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">TINY</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)))</span>&#x000A;  <span class="c1"># votre code va ici</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>C&#39;est moche, hein ? Non, je n&#39;en suis pas fier.</p> <p>C&#39;est con parce qu&#39;il suffit de savoir qu&#39;il y a deux classes Ruby vachement utiles pour comparer les numéros de versions qui sont <a href="//www.ruby-doc.org/stdlib-2.1.0/libdoc/rubygems/rdoc/Gem/Requirement.html">Gem::Requirement</a> et <a href="//www.ruby-doc.org/stdlib-2.1.0/libdoc/rubygems/rdoc/Gem/Version.html">Gem::Version</a>.</p> <p><code>Gem::Requirement</code> permet de créer des <em>matchers</em>, genre &rsquo;~&gt; 4.0.2&rsquo; (ça vous dit quelque chose ?). <code>Gem::Version</code>, comme son nom l&#39;indique intelligemment, ça stocke un numéro de version. Et le lien utile entre les deux, c&#39;est la méthode <code>satisfied_by?</code> de <code>Gem::Requirement</code> qui renvoie vrai ou faux selon si l&#39;objet <code>Gem::Version</code> qu&#39;on lui passe en paramètre est conforme au <em>matcher</em>.</p> <p>Quelques exemples :</p> <pre class="highlight ruby"><code><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'&gt;= 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'3.2'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; false</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'&gt;= 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.1'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; true</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'~&gt; 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.0.3'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; true</span>&#x000A;<span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'~&gt; 4.0.2'</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'4.1'</span><span class="p">)</span>&#x000A;<span class="c1"># =&gt; false</span>&#x000A;</code></pre> <p>Voilà, à partir de là, tout est très simple, on créé une fonction qui fait la même chose - non pas par rapport à un numéro de version arbitraire - mais par rapport au numéro de version de Rails (dans lequel le code est exécuté) :</p> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">rails_version_matches?</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>&#x000A;  <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">requirement</span><span class="p">).</span><span class="nf">satisfied_by?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">::</span><span class="kp">new</span><span class="p">(</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Il nous suffit dans le code de faire:</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="n">rails_version_matches?</span> <span class="s1">'~&gt; 4.0.2'</span>&#x000A;  <span class="c1"># du code custom ici</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Classe, non ?</p> <p>Oui, mais nous on veut vérifier plusieurs versions de Rails (souvenez-vous : &ldquo;3.2.16+ <strong>et</strong> 4.0.2+&rdquo;).</p> <p>Pour ça, on va utiliser, des fonctions similaires mais qui prennent plusieurs <em>matchers</em> en paramètre, et qui vérifie que la version courante de Rails satisfait au moins un de ces <em>matchers</em> (pour la version <code>_any</code>) ou tous ces <em>matchers</em> à la fois (pour la version <code>_all</code>) en utilisant les opérateurs booléens <code>&amp;</code> et <code>|</code> entre leurs résultats :</p> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">rails_version_matches_any?</span><span class="p">(</span><span class="o">*</span><span class="n">requirements</span><span class="p">)</span>&#x000A;  <span class="n">requirements</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">rails_version_matches?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}.</span><span class="nf">reduce</span><span class="p">(</span><span class="ss">:|</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="k">def</span> <span class="nf">rails_version_matches_all?</span><span class="p">(</span><span class="o">*</span><span class="n">requirements</span><span class="p">)</span>&#x000A;  <span class="n">requirements</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">rails_version_matches?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}.</span><span class="nf">reduce</span><span class="p">(</span><span class="ss">:&amp;</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Au final, je teste que ma version courante de Rails est 3.2.16+ ou 4.0.2+ comme ça :</p> <pre class="highlight ruby"><code><span class="k">if</span> <span class="n">rails_version_matches_any?</span> <span class="s1">'~&gt; 3.2.16'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.2'</span>&#x000A;  <span class="c1"># mon code qui va bien</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>Bien plus propre qu&#39;avant. Là, ça me plait.</p> </div> <div class=author> Publié par <a href="https://twitter.com/michaelbaudino">Michael Baudino</a> <img alt='michael.baudino@alpine-lab.com' class=avatar src='//www.gravatar.com/avatar/db878dfa87aec08092efcb7cc12ab343?size=128'> </div> </article> <aside> <h3>Autres articles récents</h3> <ul> <li><a href="/blog/utiliser-les-presences-de-phoenix/">Utiliser les Presences de Phoenix</a></li> <li><a href="/blog/skiwallet-a-la-conference-blend/">SkiWallet à la conférence Blend</a></li> <li><a href="/blog/installer-git-flow-dans-une-box-nitrous-io/">Installer git-flow dans une box Nitrous.IO</a></li> <li><a href="/blog/git-en-couleurs/">Git en couleurs</a></li> <li><a href="/blog/traduire-son-site-middleman-avec-locale/">Traduire son site Middleman avec Locale</a></li> <li><a href="/blog/generer-ses-vues-devise-en-haml/">Générer ses vues Devise en Haml</a></li> <li><a href="/blog/interdire-uniquement-l-enregistrement-de-nouveaux-utilisateurs-sous-devise/">Interdire uniquement l'enregistrement de nouveaux utilisateurs sous Devise</a></li> <li><a href="/blog/installer-font-awesome-sous-middleman/">Installer Font Awesome sous Middleman</a></li> <li><a href="/blog/un-alias-git-c-est-toujours-pratique/">Un alias git, c'est toujours pratique</a></li> </ul> </aside> </div> </div> <div id=corporate-btn> <a href="/">Alpine Lab <span class=caret></span> </a> </div> <footer> <p> Le blog d'<a rel=publisher href="https://plus.google.com/+AlpineLab">Alpine Lab</a> est publié sous license <a href="//creativecommons.org/licenses/by/3.0/fr/">Creative Commons Attribution 3.0 (cc-by-3.0)</a>. Le code est sous licence <a href="//opensource.org/licenses/MIT">MIT</a>. </p> </footer> </body> </html>