<!DOCTYPE html> <html> <head> <title>Interdire uniquement l'enregistrement de nouveaux utilisateurs sous Devise</title> <meta charset=UTF-8> <meta content="Sur un site Rails dont le contrôle d'accès est géré par Devise, on a parfois besoin d'interdire l'enregistrement de nouveaux utilisateurs (si les utilisateurs sont les administrateurs, dans le cadre d'un back office, par exemple)." name=description> <meta content='width=device-width, initial-scale=1.0, user-scalable=no' name=viewport> <meta content="Interdire uniquement l'enregistrement de nouveaux utilisateurs sous Devise" property='og:title'> <meta content="Sur un site Rails dont le contrôle d'accès est géré par Devise, on a parfois besoin d'interdire l'enregistrement de nouveaux utilisateurs (si les utilisateurs sont les administrateurs, dans le cadre d'un back office, par exemple)." property='og:description'> <meta content=fr_FR property='og:locale'> <meta content='Alpine Lab' property='og:site_name'> <meta content='http://www.alpine-lab.com/blog/interdire-uniquement-l-enregistrement-de-nouveaux-utilisateurs-sous-devise/' property='og:url'> <meta content='http://www.alpine-lab.com../../images/logo-alpinelab-500.png' property='og:image'> <meta content=article property='og:type'> <link href='images/favicon.png' rel=icon> <link href='//fonts.googleapis.com/css?family=Lato:300,400,700%7CMontserrat:400,700' rel=stylesheet> <link href="../../stylesheets/blog-fb2780ef.css" rel=stylesheet /> <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.min.css" rel=stylesheet /> </head> <body class='blog blog_interdire-uniquement-l-enregistrement-de-nouveaux-utilisateurs-sous-devise blog_interdire-uniquement-l-enregistrement-de-nouveaux-utilisateurs-sous-devise_index'> <meta content='Alpine Lab, blog technique' itemprop=name> <meta content="On parle de développement web, d'entreprenariat, de Ruby/Rails, de Haml/Slim, de Sass, de CoffeeScript et d'Ember.js" itemprop=description> <meta content='http://www.alpine-lab.com/blog' itemprop=url> <meta content=fr itemprop=inLanguage> <meta content='http://www.alpine-lab.com../../images/logo-alpinelab-500.png' itemprop=image> <div id=wrapper> <header> <a href="/blog"><div class=logo></div> <h1 class=sitename><span class=alpine>Alpine</span><span class=lab>Lab</span> <span class=blog>blog technique</span> </h1> </a> <div class=social-networks> <a target=_blank href="https://github.com/alpinelab"><i class='fa fa-github'></i> </a> <a target=_blank href="https://twitter.com/alpinelab"><i class='fa fa-twitter'></i> </a> </div> </header> <div id=main> <article itemscope itemtype='http://schema.org/BlogPosting'> <meta content="Sur un site Rails dont le contrôle d'accès est géré par Devise, on a parfois besoin d'interdire l'enregistrement de nouveaux utilisateurs (si les utilisateurs sont les administrateurs, dans le cadre d'un back office, par exemple)." itemprop=description> <meta content='http://www.alpine-lab.com/blog/interdire-uniquement-l-enregistrement-de-nouveaux-utilisateurs-sous-devise/' itemprop=url> <meta content=fr itemprop=inLanguage> <h1 itemprop='name headline'>Interdire uniquement l'enregistrement de nouveaux utilisateurs sous Devise</h1> <time class=published datetime=2013-05-06 itemprop=datePublished> Publié le 06/05/2013 </time> <ul class=tags> <li> <i class='fa fa-tags'></i> </li> <li><a href="/blog/tags/rails/">Rails</a></li> <li><a href="/blog/tags/devise/">Devise</a></li> </ul> <div class=post-body itemprop=articleBody> <p>Sur un site <a href="//rubyonrails.org">Rails</a> dont le contrôle d&#39;accès est géré par <a href="//devise.plataformatec.com.br">Devise</a>, on a parfois besoin d&#39;interdire l&#39;enregistrement de nouveaux utilisateurs (si les utilisateurs sont les administrateurs, dans le cadre d&#39;un <em>back office</em>, par exemple).</p> <p>À première vue, on pourrait se dire qu&#39;il suffit de supprimer le rôle <code>:registerable</code> dans le modèle, mais cette solution a un inconvénient majeur : elle supprime purement et simplement l&#39;accès au contrôleur <code>RegistrationsController</code>, l&#39;utilisateur ne peut donc plus modifier les information de son compte (son nom, son adresse email, son mot de passe, etc&hellip;).</p> <p>Il y a donc une autre solution, très simple, et qui permet de garder le rôle <code>:registerable</code> : on va supprimer toutes les routes menant au contrôleur, puis recréer seulement celles donc on a besoin.</p> <p>Par défaut, on a un <code>config/routes.rb</code> qui ressemble à ça :</p> <pre class="highlight ruby"><code><span class="n">devise_for</span> <span class="ss">:users</span>&#x000A;</code></pre> <p>Il faut donc le modifier pour qu&#39;il ressemble à ça :</p> <pre class="highlight ruby"><code><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:skip</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:registrations</span><span class="p">]</span>&#x000A;<span class="n">as</span> <span class="ss">:user</span> <span class="k">do</span>&#x000A;  <span class="n">get</span> <span class="s1">'users/edit'</span> <span class="o">=&gt;</span> <span class="s1">'devise/registrations#edit'</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="s1">'edit_user_registration'</span>&#x000A;  <span class="n">put</span> <span class="s1">'users'</span> <span class="o">=&gt;</span> <span class="s1">'devise/registrations#update'</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="s1">'user_registration'</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre> <p>On voit que l&#39;on supprime donc toutes les routes vers le contrôleur <code>RegistrationsController</code> (avec l&#39;option <code>:skip =&gt; [:registrations]</code>) puis que l&#39;on recrée les routes <code>edit</code> (qui affiche le formulaire de modification du compte utilisateur) et <code>update</code> (qui effectue véritablement les modifications en base de données).</p> <p>La seule erreur que cette modification va engendrer, c&#39;est que le <em>helper</em> <code>new_registration_path</code> n&#39;existe plus (puisque la route vers <code>devise/registrations#new</code> n&#39;existe plus). Il faut donc aller modifier la vue partielle <code>app/views/devise/shared/_links.html.erb</code> et <strong>supprimer la partie suivante</strong> (qui génère normalement un lien &lsquo;Sign up&rsquo;) :</p> <pre class="highlight erb"><code><span class="cp">&lt;%-</span> <span class="k">if</span> <span class="n">devise_mapping</span><span class="p">.</span><span class="nf">registerable?</span> <span class="o">&amp;&amp;</span> <span class="n">controller_name</span> <span class="o">!=</span> <span class="s1">'registrations'</span> <span class="cp">%&gt;</span>&#x000A;  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up"</span><span class="p">,</span> <span class="n">new_registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span> <span class="cp">%&gt;</span>&#x000A;<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">-%&gt;</span>&#x000A;</code></pre> <h3 id="bonus-:-ménage">Bonus : ménage</h3> <p>Si vous aviez généré les vues Devise dans votre propre application pour les personnaliser (voir le post <a href="/posts/generer-ses-vues-devise-en-haml">Générer ses vues Devise en Haml</a>), vous pouvez en supprimer une qui ne vous servira jamais (celle avec le formulaire d&#39;inscription d&#39;un nouvel utilisateur) :</p> <pre class="highlight shell"><code><span class="gp">$ </span>rm -f app/views/devise/registrations/new.html.erb&#x000A;</code></pre> <p>Perso, je ne me sers pas non plus des vues des contrôleurs <code>ConfirmationsController</code> et <code>UnlocksController</code>, donc généralement, je les vire aussi (mais après, c&#39;est à vous de voir&hellip;) :</p> <pre class="highlight shell"><code><span class="gp">$ </span>rm -rf app/views/devise/confirmations/&#x000A;<span class="gp">$ </span>rm -rf app/views/devise/unlocks/&#x000A;</code></pre> <h4 id=sources>Sources</h4> <ul> <li>cette <a href="//stackoverflow.com/questions/6734323/how-do-i-remove-the-devise-route-to-sign-up">question sur StackOverflow</a></li> <li>cet <a href="//blog.robotex.de/read/devise-disabling-sign-up">article de Robotex</a></li> <li>et bien sûr, la <a href="//devise.plataformatec.com.br">doc</a> et le <a href="https://github.com/plataformatec/devise/wiki">wiki</a> de Devise</li> </ul> </div> <div class=author> Publié par <a href="https://twitter.com/michaelbaudino">Michael Baudino</a> <img alt='michael.baudino@alpine-lab.com' class=avatar src='//www.gravatar.com/avatar/db878dfa87aec08092efcb7cc12ab343?size=128'> </div> </article> <aside> <h3>Autres articles récents</h3> <ul> <li><a href="/blog/utiliser-les-presences-de-phoenix/">Utiliser les Presences de Phoenix</a></li> <li><a href="/blog/des-helpers-pour-verifier-la-version-de-rails/">Des helpers pour vérifier la version de Rails</a></li> <li><a href="/blog/skiwallet-a-la-conference-blend/">SkiWallet à la conférence Blend</a></li> <li><a href="/blog/installer-git-flow-dans-une-box-nitrous-io/">Installer git-flow dans une box Nitrous.IO</a></li> <li><a href="/blog/git-en-couleurs/">Git en couleurs</a></li> <li><a href="/blog/traduire-son-site-middleman-avec-locale/">Traduire son site Middleman avec Locale</a></li> <li><a href="/blog/generer-ses-vues-devise-en-haml/">Générer ses vues Devise en Haml</a></li> <li><a href="/blog/installer-font-awesome-sous-middleman/">Installer Font Awesome sous Middleman</a></li> <li><a href="/blog/un-alias-git-c-est-toujours-pratique/">Un alias git, c'est toujours pratique</a></li> </ul> </aside> </div> </div> <div id=corporate-btn> <a href="/">Alpine Lab <span class=caret></span> </a> </div> <footer> <p> Le blog d'<a rel=publisher href="https://plus.google.com/+AlpineLab">Alpine Lab</a> est publié sous license <a href="//creativecommons.org/licenses/by/3.0/fr/">Creative Commons Attribution 3.0 (cc-by-3.0)</a>. Le code est sous licence <a href="//opensource.org/licenses/MIT">MIT</a>. </p> </footer> </body> </html>